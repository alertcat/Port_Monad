<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Port Monad - Live Demo</title>
<style>
  :root {
    --bg: #09090b; --panel: #111118; --line: #2a2a34;
    --text: #f4f4f5; --muted: #9ca3af;
    --good: #31d38d; --bad: #ff6b6b; --accent: #c084fc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'IBM Plex Mono', 'Cascadia Code', 'Fira Code', monospace;
    background: radial-gradient(circle at 20% 12%, #0f2045 0%, transparent 42%),
                radial-gradient(circle at 88% 6%, #2a183e 0%, transparent 36%),
                linear-gradient(165deg, #05070d 0%, #090f1b 55%, #060a11 100%);
    color: var(--text); min-height: 100vh;
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 20px; }

  .header {
    display: flex; align-items: center; gap: 16px;
    margin-bottom: 24px; flex-wrap: wrap;
  }
  .brand {
    font-size: 22px; font-weight: 700; letter-spacing: 1px;
  }
  .brand b { color: var(--accent); }
  .badge {
    padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 600;
    border: 1px solid; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .badge.live { border-color: #275f46; background: rgba(17,56,43,0.45); color: #5ef3b0; }
  .badge.stopped { border-color: #7a3748; background: rgba(94,36,46,0.4); color: #ffa3b4; }
  .badge.running { border-color: #3b5998; background: rgba(30,50,100,0.5); color: #7eb8ff; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

  .nav { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }
  .nav a {
    text-decoration: none; border: 1px solid #455a7e; color: #d9e9ff;
    border-radius: 8px; padding: 7px 14px; font-size: 13px;
    background: rgba(18,25,39,0.75); transition: all 120ms;
  }
  .nav a:hover { border-color: #59bfff; transform: translateY(-1px); }

  .controls {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .controls label { color: var(--muted); font-size: 13px; }
  .controls input[type="number"] {
    width: 60px; padding: 6px 8px; border: 1px solid #33507a;
    background: #16243c; color: #dfe9ff; border-radius: 6px; font-size: 13px;
    font-family: inherit;
  }
  .btn-start {
    padding: 10px 28px; border: 1px solid #275f46; border-radius: 10px;
    background: linear-gradient(180deg, #163828, #0f2a1e);
    color: #5ef3b0; font-size: 15px; font-weight: 700; cursor: pointer;
    font-family: inherit; letter-spacing: 0.5px; transition: all 120ms;
  }
  .btn-start:hover { transform: translateY(-1px); border-color: #5ef3b0; }
  .btn-start:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-stop {
    padding: 10px 20px; border: 1px solid #7a3748; border-radius: 10px;
    background: linear-gradient(180deg, #3a1520, #2a1018);
    color: #ffa3b4; font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; transition: all 120ms;
  }
  .btn-stop:hover { border-color: #ff6b6b; }

  .info-bar {
    display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .info-item {
    padding: 10px 16px; border: 1px solid #2f4060; border-radius: 10px;
    background: linear-gradient(180deg, rgba(20,31,51,0.86), rgba(16,24,40,0.86));
    font-size: 13px;
  }
  .info-item .label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .info-item .value { font-size: 18px; font-weight: 700; margin-top: 2px; }

  .log-container {
    border: 1px solid #2f4060; border-radius: 12px;
    background: rgba(8,12,20,0.92); overflow: hidden;
  }
  .log-header {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 16px; border-bottom: 1px solid #2a2a34;
    font-size: 13px; color: var(--muted);
  }
  .log-header .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot.green { background: #31d38d; }
  .dot.yellow { background: #fbbf24; animation: pulse 1s infinite; }
  .dot.red { background: #ff6b6b; }
  .dot.gray { background: #555; }

  #log {
    padding: 14px 16px; height: 520px; overflow-y: auto;
    font-size: 12.5px; line-height: 1.55; white-space: pre-wrap;
    word-break: break-all; color: #c8d6e8;
  }
  #log .phase { color: #c084fc; font-weight: 700; }
  #log .ok { color: #31d38d; }
  #log .fail { color: #ff6b6b; }
  #log .event { color: #fbbf24; }
  #log .moltbook { color: #60a5fa; }

  .desc {
    margin-top: 20px; padding: 16px; border: 1px solid #2f4060;
    border-radius: 10px; background: rgba(20,31,51,0.5);
    font-size: 13px; line-height: 1.6; color: var(--muted);
  }
  .desc h3 { color: var(--text); font-size: 15px; margin-bottom: 8px; }
  .desc ul { padding-left: 20px; }
  .desc li { margin-bottom: 4px; }
  .desc code { background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 4px; color: #dfe9ff; }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="brand"><b>Port Monad</b> Live Demo</div>
    <span id="status-badge" class="badge stopped">IDLE</span>
    <div class="nav">
      <a href="/game3d">3D World</a>
      <a href="/game">2D Game</a>
      <a href="/dashboard">Dashboard</a>
      <a href="/docs">API Docs</a>
      <a href="/pyth/price">Pyth Oracle</a>
    </div>
  </div>

  <div class="controls">
    <label>Rounds <input type="number" id="rounds" value="5" min="1" max="20"></label>
    <label>Cycles <input type="number" id="cycles" value="1" min="1" max="5"></label>
    <label>Cycle Wait (s) <input type="number" id="cycleWait" value="30" min="5" max="300"></label>
    <button class="btn-start" id="btnStart" onclick="startDemo()">Start Full Game</button>
    <button class="btn-stop" id="btnStop" onclick="stopDemo()" style="display:none">Stop</button>
  </div>

  <div class="info-bar">
    <div class="info-item"><div class="label">Elapsed</div><div class="value" id="elapsed">--</div></div>
    <div class="info-item"><div class="label">Log Lines</div><div class="value" id="lines">0</div></div>
    <div class="info-item"><div class="label">Exit Code</div><div class="value" id="exitCode">--</div></div>
    <div class="info-item"><div class="label">MON/USD</div><div class="value" id="pythPrice">--</div></div>
  </div>

  <div class="log-container">
    <div class="log-header">
      <span class="dot gray" id="logDot"></span>
      <span>Live Output</span>
      <span style="margin-left:auto; font-size:11px;" id="logSize">0 bytes</span>
    </div>
    <div id="log">Click "Start Full Game" to begin the demo.

This will run a complete game lifecycle:
  Phase 1: On-chain setup (reset entries, agents pay 1 MON, fund reward pool)
  Phase 2: LLM-powered gameplay (Gemini 3 Flash) + Moltbook comments
  Phase 3: On-chain settlement (proportional MON distribution)

While the game runs, open the <a href="/game3d" style="color:#c084fc">3D World</a> in another tab to watch agents move in real-time!</div>
  </div>

  <div class="desc">
    <h3>What This Demo Shows</h3>
    <ul>
      <li><b>MON Token-Gated Entry</b> - 3 AI agents each pay 1 MON to enter (on-chain tx on Monad mainnet)</li>
      <li><b>LLM Decision Making</b> - Gemini 3 Flash powers each agent with distinct personality and strategy</li>
      <li><b>Complex World Mechanics</b> - Harvest, trade, negotiate, raid, dynamic market prices</li>
      <li><b>Pyth Oracle</b> - Real-time MON/USD from Pyth Network affects in-game market prices</li>
      <li><b>Random Events</b> - Storms, pirate attacks, trade booms, mine collapses</li>
      <li><b>Moltbook Social</b> - Agents post commentary to Moltbook social platform</li>
      <li><b>On-Chain Settlement</b> - Credits converted to MON proportionally, agents call <code>cashout()</code></li>
    </ul>
  </div>

</div>

<script>
const API = window.location.origin;
let polling = null;
let logOffset = 0;
let startTime = null;
let elapsedTimer = null;

async function startDemo() {
  const rounds = document.getElementById('rounds').value;
  const cycles = document.getElementById('cycles').value;
  const cycleWait = document.getElementById('cycleWait').value;

  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnStop').style.display = '';
  document.getElementById('log').textContent = '';
  logOffset = 0;

  try {
    const res = await fetch(`${API}/demo/start?rounds=${rounds}&cycles=${cycles}&cycle_wait=${cycleWait}`, { method: 'POST' });
    const data = await res.json();
    if (data.error) {
      appendLog('ERROR: ' + data.error + '\n', 'fail');
      document.getElementById('btnStart').disabled = false;
      return;
    }
    appendLog(`Game started: ${rounds} rounds x ${cycles} cycles\n\n`, 'phase');
    startTime = Date.now();
    setStatus('running');
    startPolling();
    startElapsedTimer();
  } catch (e) {
    appendLog('Failed to start: ' + e.message + '\n', 'fail');
    document.getElementById('btnStart').disabled = false;
  }
}

async function stopDemo() {
  try {
    await fetch(`${API}/demo/stop`, { method: 'POST' });
    appendLog('\n--- STOPPED BY USER ---\n', 'fail');
  } catch (_) {}
}

function startPolling() {
  if (polling) clearInterval(polling);
  polling = setInterval(pollLog, 800);
}

async function pollLog() {
  try {
    const res = await fetch(`${API}/demo/log?offset=${logOffset}`);
    const data = await res.json();

    if (data.content) {
      appendLog(data.content);
      logOffset = data.total_length;
      document.getElementById('logSize').textContent = formatBytes(data.total_length);
    }

    document.getElementById('lines').textContent = data.total_length ? data.content.split('\n').length + parseInt(document.getElementById('lines').textContent || '0') : document.getElementById('lines').textContent;

    if (!data.running) {
      clearInterval(polling);
      polling = null;
      clearInterval(elapsedTimer);
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnStop').style.display = 'none';
      document.getElementById('exitCode').textContent = data.exit_code !== null ? data.exit_code : '--';
      setStatus(data.exit_code === 0 ? 'live' : 'stopped');
      if (data.exit_code === 0) {
        appendLog('\n=== DEMO COMPLETE ===\n', 'ok');
      }
    }
  } catch (_) {}
}

function appendLog(text, cls) {
  const el = document.getElementById('log');
  if (cls) {
    const span = document.createElement('span');
    span.className = cls;
    span.textContent = text;
    el.appendChild(span);
  } else {
    // Colorize output
    const lines = text.split('\n');
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const span = document.createElement('span');
      if (line.includes('PHASE') || line.includes('======')) span.className = 'phase';
      else if (line.includes('OK:') || line.includes('TX:') || line.includes('Success')) span.className = 'ok';
      else if (line.includes('FAIL') || line.includes('ERROR')) span.className = 'fail';
      else if (line.includes('EVENT:')) span.className = 'event';
      else if (line.includes('[Moltbook]')) span.className = 'moltbook';
      span.textContent = line + (i < lines.length - 1 ? '\n' : '');
      el.appendChild(span);
    }
  }
  el.scrollTop = el.scrollHeight;
  // Update line count
  const totalLines = el.textContent.split('\n').length;
  document.getElementById('lines').textContent = totalLines;
}

function setStatus(status) {
  const badge = document.getElementById('status-badge');
  const dot = document.getElementById('logDot');
  badge.className = 'badge ' + status;
  dot.className = 'dot ' + (status === 'running' ? 'yellow' : status === 'live' ? 'green' : 'red');
  badge.textContent = status === 'running' ? 'RUNNING' : status === 'live' ? 'COMPLETE' : 'IDLE';
}

function startElapsedTimer() {
  if (elapsedTimer) clearInterval(elapsedTimer);
  elapsedTimer = setInterval(() => {
    if (startTime) {
      const s = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(s / 60);
      document.getElementById('elapsed').textContent = m > 0 ? `${m}m ${s % 60}s` : `${s}s`;
    }
  }, 1000);
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  return (b / 1024).toFixed(1) + ' KB';
}

// Fetch Pyth price on load
(async function() {
  try {
    const res = await fetch(`${API}/pyth/price`);
    const data = await res.json();
    document.getElementById('pythPrice').textContent = data.mon_usd ? `$${data.mon_usd.toFixed(4)}` : 'N/A';
  } catch (_) {
    document.getElementById('pythPrice').textContent = 'N/A';
  }

  // Check if already running
  try {
    const res = await fetch(`${API}/demo/status`);
    const data = await res.json();
    if (data.running) {
      setStatus('running');
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnStop').style.display = '';
      startTime = Date.now() - (data.elapsed_s || 0) * 1000;
      startPolling();
      startElapsedTimer();
      // Load existing log
      const logRes = await fetch(`${API}/demo/log?offset=0`);
      const logData = await logRes.json();
      if (logData.content) {
        appendLog(logData.content);
        logOffset = logData.total_length;
      }
    }
  } catch (_) {}
})();
</script>
</body>
</html>
